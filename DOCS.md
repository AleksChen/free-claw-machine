# 自由抓娃娃机产品技术文档

## 1. 项目概述

### 1.1 项目简介

基于 MediaPipe 和 Three.js 开发的网页版体感抓娃娃机游戏，用户通过摄像头捕捉手部动作来控制虚拟抓娃娃机进行游戏。

### 1.2 核心特性

- 无需任何物理控制器，纯体感交互
- 双手协同控制，提供沉浸式体验
- 实时 3D 渲染和物理模拟
- 网页端运行，跨平台兼容

## 2. 技术架构

### 2.1 技术栈选型

| 技术模块    | 选型方案        | 作用                                    |
| ----------- | --------------- | --------------------------------------- |
| 计算机视觉  | MediaPipe Hands | 实时手部追踪与手势识别 (需处理镜像标记) |
| 3D 渲染引擎 | Three.js (r128) | 场景渲染、模型加载、操作区交互动画      |
| 物理引擎    | Cannon-es       | 刚体物理、碰撞检测、抓取模拟            |
| 交互控制    | 摇杆/按钮映射   | 左手->摇杆, 右手握拳->按钮按下          |

### 2.2 系统架构图

```
┌─────────────────────────────────────────┐
│          用户摄像头输入层                │
└───────────────┬─────────────────────────┘
                │
┌───────────────▼─────────────────────────┐
│      MediaPipe Hands 处理层              │
│  - 手部检测 (maxNumHands: 2)            │
│  - 关键点追踪 (21 landmarks per hand)   │
│  - 左右手识别                            │
└───────────────┬─────────────────────────┘
                │
┌───────────────▼─────────────────────────┐
│        手势识别与映射层                  │
│  - 坐标转换 (2D → 3D)                   │
│  - 手势解析                              │
│  - 控制指令生成                          │
└───────────────┬─────────────────────────┘
                │
┌───────────────▼─────────────────────────┐
│         Three.js 渲染层                  │
│  - 场景管理                              │
│  - 爪子模型控制                          │
│  - 娃娃/物体渲染                         │
└───────────────┬─────────────────────────┘
                │
┌───────────────▼─────────────────────────┐
│          物理模拟层                      │
│  - 碰撞检测                              │
│  - 重力模拟                              │
│  - 抓取判定                              │
└─────────────────────────────────────────┘
```

## 3. 核心功能设计

### 3.1 手部追踪功能

**MediaPipe 配置：**

```javascript
{
  maxNumHands: 2,              // 同时追踪双手
  modelComplexity: 1,          // 模型复杂度 (0-1)
  minDetectionConfidence: 0.7, // 检测置信度阈值
  minTrackingConfidence: 0.5   // 追踪置信度阈值
}
```

**输出数据结构：**

- `multiHandedness[]`: 左右手标识数组
- `multiHandLandmarks[]`: 每只手 21 个 3D 关键点坐标
- 关键点索引：0(手腕), 4(大拇指尖), 8(食指尖), 12(中指尖), 16(无名指尖), 20(小指尖)

### 3.2 双手控制方案

#### 方案 A：分工协作模式

| 手部 | 功能                 | 检测方式          |
| ---- | -------------------- | ----------------- |
| 左手 | 控制爪子 XY 平面移动 | 手掌中心位置映射  |
| 右手 | 控制抓取动作         | 握拳/张开手势识别 |

#### 方案 B：主副手模式

- **主手**（默认右手）：完整控制（移动 + 抓取）
- **副手**（左手）：辅助功能（视角旋转、重置等）

**手势定义：**

- **移动**：手掌位置 → 爪子 XY 坐标
- **下降抓取**：握拳 (手指弯曲度判定)
- **上升松开**：张开手掌 (手指展开度判定)
- **确认抓取**：保持握拳状态 > 1 秒

### 3.3 坐标映射系统

**2D → 3D 坐标转换：**

```
MediaPipe 输出：归一化坐标 [0-1]
    ↓
缩放到屏幕分辨率
    ↓
转换为 Three.js 世界坐标
    ↓
应用偏移和缩放因子
```

**映射公式示例：**

```javascript
// X轴映射 (水平)
clawX = (handX - 0.5) * gameAreaWidth;

// Y轴映射 (垂直，需要反转)
clawY = -(handY - 0.5) * gameAreaHeight;

// Z轴映射 (深度，可选)
clawZ = handZ * depthRange;
```

### 3.4 物理引擎集成

**刚体设置：**

- **爪子**：动态刚体，质量 0.5kg
- **娃娃**：动态刚体，质量 0.1-0.3kg
- **机器底座**：静态刚体

**碰撞检测：**

1. 爪子下降过程中检测与娃娃的碰撞
2. 握拳状态下，爪子闭合，触发抓取判定
3. 判定条件：娃娃在爪子包围盒内 + 距离阈值 < 设定值

**抓取逻辑：**

```
IF 握拳 AND 爪子与娃娃碰撞 THEN
    创建固定约束 (Fixed Constraint)
    娃娃父级 = 爪子
    爪子上升
END IF

IF 张开手掌 OR 到达投放区 THEN
    移除约束
    娃娃父级 = null
    应用重力
END IF
```

## 4. 3D 场景设计

### 4.1 场景组件

```
Scene
├── Camera (透视相机，FOV: 45°)
├── Lights
│   ├── AmbientLight (环境光)
│   ├── DirectionalLight (定向光 × 2)
│   └── PointLight (点光源，可选)
├── ClawMachine (抓娃娃机模型)
│   ├── Frame (机身框架)
│   ├── Glass (玻璃罩)
│   ├── Claw (爪子 - 可动)
│   └── OutputSlot (出口)
├── Prizes[] (娃娃数组)
│   └── Prize (单个娃娃模型)
└── Floor (地面/底座)
```

### 4.2 爪子模型设计

**结构组成：**

- 顶部连接杆
- 3-4 个爪瓣（可旋转关节）
- 爪尖碰撞体

**动画状态：**

- **待机**：爪子张开，轻微摆动
- **移动**：跟随手部位置
- **下降**：匀速下降，爪子保持张开
- **抓取**：爪瓣闭合动画（0.3-0.5 秒）
- **上升**：匀速上升至顶部
- **投放**：移动至出口，爪子张开

## 5. 性能优化策略

### 5.1 性能瓶颈分析

| 模块           | 性能消耗 | 优化优先级 |
| -------------- | -------- | ---------- |
| MediaPipe 推理 | 高       | ⭐⭐⭐⭐⭐ |
| Three.js 渲染  | 中       | ⭐⭐⭐⭐   |
| 物理模拟       | 中       | ⭐⭐⭐     |
| 手势识别计算   | 低       | ⭐⭐       |

### 5.2 优化方案

**MediaPipe 优化：**

- 降低输入视频分辨率（640×480 或 480×360）
- 设置合理的 `modelComplexity`（推荐值：1）
- 使用 Web Worker 异步处理

**Three.js 优化：**

- 降低娃娃模型面数（< 5000 三角形）
- 使用 LOD (Level of Detail) 技术
- 启用 Frustum Culling（视锥体剔除）
- 合批静态物体

**物理引擎优化：**

- 限制活动刚体数量（< 20）
- 降低物理更新频率（30-45 FPS）
- 简化碰撞体形状（使用包围盒代替精确网格）

**帧率控制：**

```javascript
// 目标：保持 30 FPS 以上
- MediaPipe: 30 FPS
- Three.js 渲染: 60 FPS
- 物理模拟: 45 FPS
```
